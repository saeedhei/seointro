# src\apollo\resolvers.ts

export const resolvers = {
Query: {
viewer: () => ({
id: 1,
name: 'John Smith',
status: 'Server-rendered âœ…',
}),
},
};

// src\apollo\schema.ts
import { makeExecutableSchema } from '@graphql-tools/schema';
import { typeDefs } from './type-defs';
import { resolvers } from './resolvers';

export const schema = makeExecutableSchema({
typeDefs,
resolvers,
});

# src\apollo\type-defs.ts

import { gql } from 'graphql-tag';

export const typeDefs = gql`
type User {
id: ID!
name: String!
status: String!
}

type Query {
viewer: User
}
`;

# src/app/api/graphql/route.ts

import { ApolloServer } from '@apollo/server';
import { startServerAndCreateNextHandler } from '@as-integrations/next';
import { NextRequest } from 'next/server';
import { schema } from '@/apollo/schema';

const server = new ApolloServer({
schema,
formatError: (error) => {
console.error('GraphQL Error:', error);
return error;
},
});

const handler = startServerAndCreateNextHandler<NextRequest>(server, {
context: async (req) => {
const token = req.headers.get('authorization') ?? null;
return { token };
},
});

export { handler as GET, handler as POST };

# src\lib\apollo-client.ts

import { ApolloClient, InMemoryCache, HttpLink } from '@apollo/client';
import { SchemaLink } from '@apollo/client/link/schema';
import { schema } from '@/apollo/schema';
import merge from 'deepmerge';

let apolloClient: ApolloClient | null = null;

function createApolloClient(ssr = false) {
const link = ssr
? new SchemaLink({ schema }) // Ø¨Ø±Ø§ÛŒ SSR Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª HTTP
: new HttpLink({
uri: process.env.NEXT_PUBLIC_GRAPHQL_URL ?? '/api/graphql',
credentials: 'same-origin',
});

return new ApolloClient({
ssrMode: ssr,
link,
cache: new InMemoryCache({
typePolicies: {
Query: {
fields: {
viewer: {
merge: true,
},
},
},
},
}),
});
}

export function initializeApollo(initialState: any = null, ssr = false) {
const \_apolloClient = apolloClient ?? createApolloClient(ssr);

if (initialState) {
const existingCache = \_apolloClient.extract() as Record<string, any>;
const data = merge<Record<string, any>>(existingCache, initialState as Record<string, any>);
\_apolloClient.cache.restore(data);
}

if (ssr) return \_apolloClient;
if (!apolloClient) apolloClient = \_apolloClient;

return \_apolloClient;
}

export function useApollo(initialState: any) {
return initializeApollo(initialState);
}

# src\app\providers.tsx

'use client';

import { ApolloProvider } from '@apollo/client/react';
import { initializeApollo } from '@/lib/apollo-client';

export default function Providers({
children,
initialApolloState,
}: {
children: React.ReactNode;
initialApolloState?: any;
}) {
const client = initializeApollo(initialApolloState);
return <ApolloProvider client={client}>{children}</ApolloProvider>;
}

# src\app\page.tsx

import { gql } from '@apollo/client';
import { initializeApollo } from '@/lib/apollo-client';
import Providers from './providers';

export const revalidate = 60; // ISR: ØµÙØ­Ù‡ Ù‡Ø± 60 Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

// Type-safe ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯Ù† query result
interface Viewer {
id: string;
name: string;
status: string;
}

interface ViewerData {
viewer: Viewer;
}

// GraphQL query
const VIEWER_QUERY = gql`  query Viewer {
    viewer {
      id
      name
      status
    }
  }`;

export default async function Home() {
// Ø§ÛŒØ¬Ø§Ø¯ Apollo Client Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø¨Ø§ SchemaLink
const apolloClient = initializeApollo(null, true);

// Ø§Ø¬Ø±Ø§ÛŒ query Ø¯Ø± Ø³Ø±ÙˆØ± (SSR prefetch)
const { data } = await apolloClient.query<ViewerData>({
query: VIEWER_QUERY,
});

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ cache Ø¨Ø±Ø§ÛŒ hydration
const initialState = apolloClient.cache.extract();

return (
<Providers initialApolloState={initialState}>

<main className="p-6">
<h1 className="text-2xl font-bold mb-2">ğŸš€ SSR Prefetch + Apollo</h1>

        {data?.viewer ? (
          <p>
            ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† <b>{data.viewer.name}</b> Ùˆ ÙˆØ¶Ø¹ÛŒØª: <b>{data.viewer.status}</b>
          </p>
        ) : (
          <p>âŒ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
        )}
      </main>
    </Providers>

);
}

# src\app\layout.tsx

import type { Metadata } from 'next';
import { Geist, Geist_Mono } from 'next/font/google';
import './globals.css';

const geistSans = Geist({
variable: '--font-geist-sans',
subsets: ['latin'],
});

const geistMono = Geist_Mono({
variable: '--font-geist-mono',
subsets: ['latin'],
});

export const metadata: Metadata = {
title: 'Create Next App',
description: 'Generated by create next app',
};

export default function RootLayout({
children,
}: Readonly<{
children: React.ReactNode;
}>) {
return (

<html lang="en">
<body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>{children}</body>
</html>
);
}
